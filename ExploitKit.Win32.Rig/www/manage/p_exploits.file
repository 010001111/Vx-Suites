<?php

include_once('./gears/page_php_header.php');

if ($config['user']['rights']['pages']['p_options']['is']!='on') { Exit('<h1>Access denied</h1>'); } 

// ============================== CODE ============================== //
?>

<h1>Exploits stats</h1>

<script>
	$(document).ready(function(){ $('#waitPageModal').modal('hide'); });
</script>


<?php

if ($config['user']['rights']['rolename']=='admin') {
// НАСТРОЙКИ ДЛЯ АДМИНА
?>

<script>

	function saveExploitsStat() {
		var expdata = {};
		$('.listing').find('.rig_line').each(function(){
			var name = $(this).find('.rig_line_1 input').val();
			var fault = $(this).find('.rig_line_2 input').val();
			expdata[$(this).attr('data-rigLineId')] = {id: $(this).attr('data-rigLineId'), name: name, fault: fault};
			if (name=='') $(this).remove();
		});

		$.ajax({
			url: './gears/saveExploitStats.php',
			type: 'POST',
			dataType: 'JSON',
			async: false,
			data : expdata,
			success: function(data) {
				notify(data.type,data.msg);
				$('.listing tbody tr :last').attr('data-rigLineId', parseInt(data.exploit_id)+1); // последняя + 1
			},
			error: function(var1, var2, var3) {
				console.log(var1, var2, var3);
			}
		});		
	}

	function addExploitLine() {
		var trCount = parseInt($('.listing tbody tr :last').attr('data-rigLineId'))+1;
		if (!trCount) trCount = 1;
		var line = '<tr class="rig_line" data-rigLineId="'+trCount+'"><td class="rig_line_1" width="60%"><span>Название эксплоита</span><input style="width:99%;"></td><td class="rig_line_2"><span>сколько палит</span><input style="width:99%;"></td></tr>';		
		$('.listing tbody').append(line);
	}	

</script>

<table class="listing">
<thead><tr><th>Название эксплоита</th><th>сколько палит</th></tr></thead>
<tbody>
	<?php
	
		$exploits = cdim('db','query',"SELECT * FROM `exploits` ORDER BY `id` ASC");
		if (isset($exploits)) foreach($exploits as $k=>$v) {

			echo '
					<tr class="rig_line" data-rigLineId="'.$v->id.'">
						<td class="rig_line_1"width="60%"><span>Название эксплоита</span><input style="width:99%;" value="'.$v->name.'"></td>
						<td class="rig_line_2"><span>сколько палит</span><input style="width:99%;" value="'.$v->fault.'"></td>
					</tr>
				';

			
		}

	?>

</tbody>
</table>
<small>Чтобы удалить запись, просто оставьте поле названия пустым</small><br>
<div style="text-align:left;float:left;margin-top:10px;"><input value="Добавить эксплоит" type="button" class="btn" onclick="addExploitLine()"></div>
<div style="text-align:right;margin-top:10px;"><input value="Сохранить" type="button" class="btn" onclick="saveExploitsStat()"></div>

<?php 
} else {
// НАСТРОЙКИ ДЛЯ ПОЛЬЗОВАТЕЛЯ
?>

<table class="listing">
<thead><tr><th>Название эксплоита</th><th>сколько палит</th></tr></thead>
<tbody>
	<?php
	
		$exploits = cdim('db','query',"SELECT * FROM `exploits` ORDER BY `id` ASC");
		if (isset($exploits)) foreach($exploits as $k=>$v) {

			echo '
					<tr class="rig_line">
						<td class="rig_line_1"width="60%"><span>Название эксплоита</span>'.$v->name.'</td>
						<td class="rig_line_2"><span>сколько палит</span>'.$v->fault.'</td>
					</tr>
				';

			
		}

	?>

</tbody>
</table>


<?php } ?>